<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ABIS Live - Direct Fetch Test</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: 0; }
    }
    .animate-in { animation: fadeIn 0.7s ease-out; }
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>
<body class="bg-slate-950 text-slate-200">
  <div id="root"></div>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState } = React;

    // Icons (simplified)
    const Shield = ({size=24}) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
      </svg>
    );

    const Zap = ({size=24}) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="currentColor" strokeWidth="2">
        <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
      </svg>
    );

    const Info = ({size=24}) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/>
      </svg>
    );

    const App = () => {
      const [opportunities, setOpportunities] = useState([]);
      const [isLoading, setIsLoading] = useState(false);
      const [error, setError] = useState(null);
      const [lastFetch, setLastFetch] = useState(null);

      // API Configuration - Using your keys
      const API_KEYS = {
        primary: "0d7491630a8624fe87ea1da0dad2ea3f",
        backup: "64a74abb6980d161caf1ab8ff856dea9"
      };

      // UK Leagues to fetch
      const UK_LEAGUES = [
        { key: 'soccer_epl', name: 'Premier League' },
        { key: 'soccer_efl_champ', name: 'Championship' },
        { key: 'soccer_england_league1', name: 'League One' },
        { key: 'soccer_england_league2', name: 'League Two' },
        { key: 'soccer_fa_cup', name: 'FA Cup' },
        { key: 'soccer_england_efl_cup', name: 'EFL Cup' },
        { key: 'soccer_spl', name: 'Scottish Premiership' },
        { key: 'soccer_england_national_league', name: 'National League' }
      ];

      const fetchDirectOdds = async (sport, apiKey) => {
        const url = `https://api.the-odds-api.com/v4/sports/${sport}/odds/?apiKey=${apiKey}&regions=uk&markets=h2h&oddsFormat=decimal`;
        
        try {
          const response = await fetch(url);
          if (response.ok) {
            return await response.json();
          } else if (response.status === 429) {
            console.log('Rate limit hit, trying backup...');
            return null;
          } else {
            console.error(`API error for ${sport}: ${response.status}`);
            return [];
          }
        } catch (err) {
          console.error(`Fetch error for ${sport}:`, err);
          return [];
        }
      };

      const analyzeMatch = (event, leagueName) => {
        const bookmaker = event.bookmakers?.[0];
        const market = bookmaker?.markets?.find(m => m.key === 'h2h');
        
        if (!market || !market.outcomes || market.outcomes.length < 2) {
          return null;
        }

        const homeOutcome = market.outcomes.find(o => o.name === event.home_team);
        const awayOutcome = market.outcomes.find(o => o.name === event.away_team);
        const drawOutcome = market.outcomes.find(o => o.name === 'Draw');

        if (!homeOutcome || !awayOutcome) return null;

        const homeOdds = homeOutcome.price;
        const awayOdds = awayOutcome.price;
        const drawOdds = drawOutcome?.price || 3.5;

        const homeProb = (1 / homeOdds) * 100;
        const awayProb = (1 / awayOdds) * 100;
        const drawProb = (1 / drawOdds) * 100;

        let selection, odds, confidence, predictedScore, strategy;

        if (homeProb > awayProb && homeProb > drawProb) {
          selection = "Home Win";
          odds = homeOdds;
          confidence = Math.min(95, Math.max(70, Math.round(homeProb + 5)));
          predictedScore = homeProb > 70 ? "3-0" : homeProb > 60 ? "2-0" : "2-1";
          strategy = homeOdds < 1.5 ? "Heavy Favorite" : homeOdds < 2.0 ? "Clear Favorite" : "Home Advantage";
        } else if (awayProb > homeProb && awayProb > drawProb) {
          selection = "Away Win";
          odds = awayOdds;
          confidence = Math.min(95, Math.max(70, Math.round(awayProb + 5)));
          predictedScore = awayProb > 70 ? "0-3" : awayProb > 60 ? "0-2" : "1-2";
          strategy = awayOdds < 2.0 ? "Strong Away Form" : "Away Value";
        } else {
          selection = "Draw";
          odds = drawOdds;
          confidence = Math.min(88, Math.max(70, Math.round(drawProb + 5)));
          predictedScore = "1-1";
          strategy = "Evenly Matched";
        }

        return {
          id: event.id,
          event: `${event.home_team} vs ${event.away_team}`,
          league: leagueName,
          selection,
          odds,
          confidence,
          reasoning: `${selection} recommended with ${confidence}% confidence based on current market odds. ${leagueName} fixture with ${strategy.toLowerCase()} characteristics.`,
          predictedScore,
          strategy,
          bookie: bookmaker?.title || 'Market Average',
          commence_time: event.commence_time,
          isToday: new Date(event.commence_time).toDateString() === new Date().toDateString(),
          isLive: new Date(event.commence_time) < new Date(),
          type: 'Market Analysis',
          customerType: 'All Users',
          url: `https://www.google.com/search?q=${encodeURIComponent(event.home_team + ' vs ' + event.away_team + ' odds')}`
        };
      };

      const fetchAllMatches = async () => {
        setIsLoading(true);
        setError(null);
        
        const allRecommendations = [];
        const now = new Date();
        const windowStart = new Date(now.getTime() - (12 * 60 * 60 * 1000));
        const windowEnd = new Date(now.getTime() + (2 * 24 * 60 * 60 * 1000)); // 2 days ahead as requested

        console.log('Fetching matches from', UK_LEAGUES.length, 'UK leagues...');

        for (const league of UK_LEAGUES) {
          try {
            console.log(`Fetching ${league.name}...`);
            
            // Try primary key first
            let events = await fetchDirectOdds(league.key, API_KEYS.primary);
            
            // If primary fails (rate limit), try backup
            if (events === null) {
              console.log(`Primary key failed for ${league.name}, using backup...`);
              events = await fetchDirectOdds(league.key, API_KEYS.backup);
            }

            if (events && events.length > 0) {
              console.log(`‚úÖ ${league.name}: ${events.length} events found`);
              
              events.forEach(event => {
                const eventTime = new Date(event.commence_time);
                
                if (eventTime >= windowStart && eventTime <= windowEnd) {
                  const analysis = analyzeMatch(event, league.name);
                  if (analysis) {
                    allRecommendations.push(analysis);
                  }
                }
              });
            } else {
              console.log(`‚ùå ${league.name}: No events`);
            }
          } catch (err) {
            console.error(`Error fetching ${league.name}:`, err);
          }
        }

        console.log(`Total recommendations: ${allRecommendations.length}`);
        
        // Sort by confidence
        allRecommendations.sort((a, b) => b.confidence - a.confidence);
        
        setOpportunities(allRecommendations);
        setLastFetch(new Date());
        setIsLoading(false);

        if (allRecommendations.length === 0) {
          setError('No matches found in the next 2 days. The Odds API may not have UK matches scheduled, or all API keys have hit rate limits.');
        }
      };

      return (
        <div className="min-h-screen bg-slate-950 text-slate-200">
          {/* Header */}
          <nav className="fixed top-0 left-0 right-0 h-20 bg-slate-900/80 backdrop-blur-xl border-b border-slate-800 z-50 px-6 lg:px-12 flex items-center justify-between">
            <div className="flex items-center gap-4">
              <div className="bg-blue-600 p-2 rounded-xl shadow-lg shadow-blue-600/20">
                <Shield size={24} className="text-white" />
              </div>
              <div>
                <h1 className="text-xl font-black text-white tracking-tighter uppercase italic">ABIS Live</h1>
                <p className="text-[9px] text-blue-400 font-black tracking-[0.2em] uppercase">Direct Fetch Test</p>
              </div>
            </div>

            <div className="flex items-center gap-3">
              <button
                onClick={fetchAllMatches}
                disabled={isLoading}
                className="bg-amber-600 hover:bg-amber-500 disabled:bg-slate-700 text-white px-6 py-3 rounded-2xl text-xs font-black transition-all active:scale-95 flex items-center gap-2"
              >
                {isLoading ? (
                  <>
                    <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin" />
                    FETCHING...
                  </>
                ) : (
                  <>
                    <Zap size={16} className="fill-current" />
                    FETCH UK MATCHES
                  </>
                )}
              </button>
            </div>
          </nav>

          {/* Main Content */}
          <main className="pt-28 pb-12 px-6 lg:px-12 max-w-[1600px] mx-auto">
            <header className="mb-12">
              <h2 className="text-3xl font-black text-white tracking-tight mb-2">
                UK Football Matches
              </h2>
              <p className="text-slate-500 font-medium">
                Direct API fetch - Next 2 days ‚Ä¢ All UK leagues
                {lastFetch && (
                  <span className="ml-2 text-xs">
                    ‚Ä¢ Last updated: {lastFetch.toLocaleTimeString()}
                  </span>
                )}
              </p>
            </header>

            {/* Loading State */}
            {isLoading && (
              <div className="text-center py-20">
                <div className="w-16 h-16 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-4" />
                <p className="text-slate-400 font-bold">Fetching live UK matches...</p>
                <p className="text-slate-600 text-sm mt-2">This may take 10-30 seconds</p>
              </div>
            )}

            {/* Error State */}
            {error && !isLoading && (
              <div className="text-center py-20 bg-red-500/5 border-2 border-dashed border-red-500/20 rounded-[3rem]">
                <div className="w-16 h-16 bg-red-500/20 rounded-full flex items-center justify-center mb-6 mx-auto">
                  <Info className="text-red-500" size={32} />
                </div>
                <h3 className="text-2xl font-black text-white mb-2">No Matches Found</h3>
                <p className="text-slate-400 max-w-lg mx-auto font-medium mb-6 px-4">
                  {error}
                </p>
                <button
                  onClick={fetchAllMatches}
                  className="bg-blue-600 hover:bg-blue-500 text-white px-8 py-4 rounded-2xl font-black text-sm transition-all"
                >
                  RETRY FETCH
                </button>
              </div>
            )}

            {/* Empty State (no error, not loading, no data) */}
            {!isLoading && !error && opportunities.length === 0 && (
              <div className="text-center py-20 bg-slate-900/40 border-2 border-dashed border-slate-800 rounded-[3rem]">
                <div className="w-16 h-16 bg-slate-800 rounded-full flex items-center justify-center mb-6 mx-auto">
                  <Zap className="text-slate-600" size={32} />
                </div>
                <h3 className="text-2xl font-black text-white mb-2">Ready to Fetch</h3>
                <p className="text-slate-500 max-w-sm mx-auto font-medium mb-6">
                  Click "FETCH UK MATCHES" to load live betting opportunities from The Odds API
                </p>
              </div>
            )}

            {/* Results */}
            {!isLoading && opportunities.length > 0 && (
              <>
                <div className="mb-8 p-6 bg-emerald-500/5 border border-emerald-500/20 rounded-2xl">
                  <h3 className="text-lg font-black text-emerald-400 mb-2">
                    ‚úÖ {opportunities.length} Matches Found
                  </h3>
                  <p className="text-sm text-slate-400">
                    Showing all UK matches in the next 2 days with confidence scores
                  </p>
                </div>

                {/* Group by league */}
                {UK_LEAGUES.map(league => {
                  const leagueMatches = opportunities.filter(o => o.league === league.name);
                  
                  if (leagueMatches.length === 0) return null;
                  
                  return (
                    <div key={league.key} className="mb-12">
                      <div className="flex items-center gap-3 mb-6">
                        <div className="h-px flex-1 bg-slate-800"></div>
                        <h4 className="text-sm font-black text-blue-400 uppercase tracking-widest px-4 py-2 bg-blue-500/10 rounded-full border border-blue-500/20">
                          {league.name} ({leagueMatches.length})
                        </h4>
                        <div className="h-px flex-1 bg-slate-800"></div>
                      </div>
                      
                      <div className="grid gap-4">
                        {leagueMatches.map(match => (
                          <div 
                            key={match.id} 
                            className={`bg-slate-900 border rounded-2xl p-6 hover:border-blue-500/50 transition-all ${
                              match.confidence >= 90 ? 'border-emerald-500/40 ring-2 ring-emerald-500/20' : 'border-slate-800'
                            }`}
                          >
                            <div className="flex flex-col md:flex-row justify-between gap-4">
                              <div className="flex-1">
                                <div className="flex items-center gap-3 mb-3">
                                  {match.confidence >= 90 && (
                                    <span className="px-3 py-1 rounded-full text-[10px] font-black uppercase bg-emerald-500/20 text-emerald-400 border border-emerald-500/30">
                                      ‚≠ê HIGH CONFIDENCE
                                    </span>
                                  )}
                                  {match.isToday && (
                                    <span className="px-3 py-1 rounded-full text-[10px] font-black uppercase bg-amber-500/20 text-amber-400 border border-amber-500/30">
                                      ‚ö° TODAY
                                    </span>
                                  )}
                                  {match.isLive && (
                                    <span className="px-3 py-1 rounded-full text-[10px] font-black uppercase bg-red-500/20 text-red-400 border border-red-500/30 animate-pulse">
                                      üî¥ LIVE
                                    </span>
                                  )}
                                </div>
                                
                                <h3 className="text-xl font-bold text-white mb-2">{match.event}</h3>
                                
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                  <div>
                                    <p className="text-slate-500 text-[10px] uppercase mb-1">Prediction</p>
                                    <p className="text-white font-bold">{match.selection}</p>
                                  </div>
                                  <div>
                                    <p className="text-slate-500 text-[10px] uppercase mb-1">Odds</p>
                                    <p className="text-emerald-400 font-bold">{match.odds}</p>
                                  </div>
                                  <div>
                                    <p className="text-slate-500 text-[10px] uppercase mb-1">Confidence</p>
                                    <p className="text-white font-bold">{match.confidence}%</p>
                                  </div>
                                  <div>
                                    <p className="text-slate-500 text-[10px] uppercase mb-1">Score</p>
                                    <p className="text-blue-400 font-bold">{match.predictedScore}</p>
                                  </div>
                                </div>

                                <div className="mt-3 pt-3 border-t border-slate-800">
                                  <p className="text-xs text-slate-400">
                                    <span className="text-slate-300 font-bold">Bookmaker:</span> {match.bookie}
                                  </p>
                                  <p className="text-xs text-slate-400 mt-1">
                                    <span className="text-slate-300 font-bold">Kick-off:</span> {new Date(match.commence_time).toLocaleString()}
                                  </p>
                                </div>
                              </div>

                              <div className="flex flex-col justify-between items-end gap-3">
                                <div className="text-right">
                                  <p className="text-[9px] text-slate-500 uppercase mb-1">Strategy</p>
                                  <p className="text-sm font-bold text-blue-400">{match.strategy}</p>
                                </div>
                                
                                <a 
                                  href={match.url} 
                                  target="_blank" 
                                  rel="noopener noreferrer"
                                  className="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-xl text-xs font-black transition-all"
                                >
                                  VIEW ODDS
                                </a>
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  );
                })}
              </>
            )}
          </main>
        </div>
      );
    };

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
